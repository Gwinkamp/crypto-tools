package extractor_test

import (
	"os"
	"testing"

	"github.com/Gwinkamp/crypto-tools/certificates/extractor"
	"github.com/stretchr/testify/require"
)

const testCertInPEM string = `-----BEGIN CERTIFICATE-----
MIIHWDCCBwWgAwIBAgIRAyOd9gCosRyaRUnGGTUwMe8wCgYIKoUDBwEBAwIwggEP
MRgwFgYFKoUDZAESDTEwMjQwMDE0MzQwNDkxGjAYBggqhQMDgQMBARIMMDA0MDI5
MDE3OTgxMQswCQYDVQQGEwJSVTEeMBwGA1UECAwVNDAg0JrQsNC70YPQttGB0LrQ
sNGPMRkwFwYDVQQHDBDQsy4g0JrQsNC70YPQs9CwMSwwKgYDVQQJDCPQv9C10YAu
INCi0LXRgNC10L3QuNC90YHQutC40Lkg0LQuNjEnMCUGA1UECgwe0JDQniDQmtCQ
0JvQo9CT0JAg0JDQodCi0KDQkNCbMTgwNgYDVQQDDC/QotC10YHRgtC+0LLRi9C5
INCQ0J4g0JrQkNCb0KPQk9CQINCQ0KHQotCg0JDQmzAeFw0yNDA3MDkxNDQ3NTRa
Fw0yNTEwMDkxNDU3NTRaMIH8MR0wGwYJKoZIhvcNAQkBFg5lLmhhcnRAbWFpbC5y
dTEWMBQGBSqFA2QDEgs0NzE1MjA1MTQ1OTEaMBgGCCqFAwOBAwEBEgw5NjMwMDgz
MjMwNDAxEzARBgNVBCoMCtCf0LDRg9C70YwxGTAXBgNVBAQMENCQ0YLRgNC10LnQ
tNC10YExCzAJBgNVBAYTAlJVMS0wKwYDVQQIDCQ0MCDQmtCw0LvRg9C20YHQutCw
0Y8g0L7QsdC70LDRgdGC0YwxFTATBgNVBAcMDNCa0LDQu9GD0LPQsDEkMCIGA1UE
Awwb0JDRgtGA0LXQudC00LXRgSDQn9Cw0YPQu9GMMGYwHwYIKoUDBwEBAQEwEwYH
KoUDAgIkAAYIKoUDBwEBAgIDQwAEQB11noIc1HQCs652LWqhqCfI6qIRmjpTjxHk
46T4CEEuWm/w7pU7y1FDsAKfBOm6ZhluUJoksXGn0nELt8Q3dv6jggRDMIIEPzAd
BgNVHQ4EFgQU7Tk8oZmf3elO5U6cNjtXVkaWDAAwHwYJKwYBBAGCNxUHBBIwEAYI
KoUDAgIuAAgCAQECAQAwHQYDVR0lBBYwFAYIKwYBBQUHAwIGCCsGAQUFBwMEMAwG
BSqFA2RyBAMCAQAwDgYDVR0PAQH/BAQDAgP4MCcGCSsGAQQBgjcVCgQaMBgwCgYI
KwYBBQUHAwIwCgYIKwYBBQUHAwQwUQYIKwYBBQUHAQEERTBDMEEGCCsGAQUFBzAC
hjVodHRwOi8vcmVnc2VydmljZS5rZXlkaXNrLnJ1L3Rlc3RjYS9yb290L3Rlc3Rj
YTE0LmNydDAdBgNVHSAEFjAUMAgGBiqFA2RxATAIBgYqhQNkcQIwggFKBgUqhQNk
cASCAT8wggE7DFPQodCa0JfQmCAi0JrRgNC40L/RgtC+0J/QoNCeIENTUCIgKNCy
0LXRgNGB0LjRjyA0LjApICjQuNGB0L/QvtC70L3QtdC90LjQtSAyIC1CYXNlKQyB
kdCf0YDQvtCz0YDQsNC80LzQvdC+LdCw0L/Qv9Cw0YDQsNGC0L3Ri9C5INC60L7Q
vNC/0LvQtdC60YEgItCj0LTQvtGB0YLQvtCy0LXRgNGP0Y7RidC40Lkg0YbQtdC9
0YLRgCAi0JrRgNC40L/RgtC+0J/RgNC+INCj0KYiINCy0LXRgNGB0LjQuNC4IDIu
MCIMIdCh0KQvMTI0LTMzODAg0L7RgiAxMSDQvNCw0Y8gMjAxOAwt0KHQpC8xMjgt
MzU5MiDQvtGCIDE3INC+0LrRgtGP0LHRgNGPIDIwMTgg0LMuMDsGBSqFA2RvBDIM
MNCh0JrQl9CYICLQmtGA0LjQv9GC0L7Qn9GA0L4iICjQstC10YDRgdC40Y8gNC4w
KTBFBgNVHR8EPjA8MDqgOKA2hjRodHRwOi8vcmVnc2VydmljZS5rZXlkaXNrLnJ1
L3Rlc3RjYS9jcmwvdGVzdGNhMTQuY3JsMIIBUQYDVR0jBIIBSDCCAUSAFKY9ADEi
mZhRzEdMKI6my6vy6VV3oYIBF6SCARMwggEPMRgwFgYFKoUDZAESDTEwMjQwMDE0
MzQwNDkxGjAYBggqhQMDgQMBARIMMDA0MDI5MDE3OTgxMQswCQYDVQQGEwJSVTEe
MBwGA1UECAwVNDAg0JrQsNC70YPQttGB0LrQsNGPMRkwFwYDVQQHDBDQsy4g0JrQ
sNC70YPQs9CwMSwwKgYDVQQJDCPQv9C10YAuINCi0LXRgNC10L3QuNC90YHQutC4
0Lkg0LQuNjEnMCUGA1UECgwe0JDQniDQmtCQ0JvQo9CT0JAg0JDQodCi0KDQkNCb
MTgwNgYDVQQDDC/QotC10YHRgtC+0LLRi9C5INCQ0J4g0JrQkNCb0KPQk9CQINCQ
0KHQotCg0JDQm4IRA3Rz2QCSsCOzSFivlxyVbqkwCgYIKoUDBwEBAwIDQQAbKizg
lbrlHd5HbInT1VqduOAxWlFzqSQ/057v3q60J9SLoxndNfu6nF70eJo25xJVwLQj
xUnVKHXxGxkQmhWk
-----END CERTIFICATE-----
`

func TestExtractCertFromPKCS7__WithB64Encoded(t *testing.T) {
	sign, err := os.ReadFile("./testdata/sign.txt")
	if err != nil {
		panic(err)
	}

	cert, err := extractor.ExtractCertFromPKCS7(sign, extractor.WithB64Encoded())
	require.NoError(t, err)
	require.Equal(t, testCertInPEM, string(cert))
}

func TestExtractCertFromPKCS7__WithDerEncoded(t *testing.T) {
	sign, err := os.ReadFile("./testdata/sign.p7s")
	if err != nil {
		panic(err)
	}

	cert, err := extractor.ExtractCertFromPKCS7(sign)
	require.NoError(t, err)
	require.Equal(t, testCertInPEM, string(cert))
}
